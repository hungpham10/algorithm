proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=WORDPRESS:100m inactive=60m use_temp_path=off;
proxy_cache_key "$scheme$request_method$host$request_uri";
proxy_cache_valid 200 301 302 60m;

server {
    server_name %%HTTP_SERVER%%;
    listen %%HTTP_PORT%%;

    root /var/www/html;
    index index.php index.html;

    # Biến kiểm soát cache
    set $skip_cache 0;

    # Bỏ qua cache cho API, admin, đăng nhập, và các yêu cầu động
    if ($request_uri ~* "/(wp-install.php|wp-login.php|wp-json/|xmlrpc.php|api/ecommerce)") {
        set $skip_cache 1;
    }
    if ($http_cookie ~* "wordpress_logged_in|wp-postpass|wp_resetpass") {
        set $skip_cache 1;
    }
    if ($request_method ~* "(POST|PUT|DELETE)") {
        set $skip_cache 1; # Bỏ qua cache cho các method không phải GET
    }

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    # @NOTE: render UI from our woocommerce service
    location ~ \.php$ {
	proxy_pass http://%%WOOCOMMERCE_SERVER%%;
    	proxy_set_header Host $host;
    	proxy_set_header X-Real-IP $remote_addr;
    	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    	proxy_set_header X-Forwarded-Proto $scheme;
	proxy_cache WORDPRESS;
        proxy_cache_bypass $skip_cache;
        proxy_no_cache $skip_cache;
        proxy_cache_valid 200 301 302 60m;
        proxy_cache_use_stale error timeout invalid_header updating;
        add_header X-Cache-Status $upstream_cache_status; # Thêm header để debug
    }

    # @TODO: some image will be managed automatically in the future using
    #        cdn so we could easily upload image directly to cdn, we should
    #        have APIs to manage this and optimize this for mobile
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg|eot|otf|ttc|ttf|ttc|zip|pdf|doc|docx)$ {
        proxy_pass http://%%WOOCOMMERCE_SERVER%%;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        expires max;
        log_not_found off;
        proxy_cache WORDPRESS;
        proxy_cache_valid 200 30d; # Cache file tĩnh 30 ngày
        proxy_cache_bypass $skip_cache;
        proxy_no_cache $skip_cache;
        add_header X-Cache-Status $upstream_cache_status;
    }

    location = /favicon.ico {
        log_not_found off;
        access_log off;
    }

    location = /robots.txt {
        allow all;
        access_log off;
        log_not_found off;
    }

    location ~ /\.ht {
        deny all;
    }

    # @NOTE: health api which define status of the whole system
    location /health {
	proxy_pass http://127.0.0.1:8000/health;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        access_log off;
    }

    # @NOTE: In the future we will wrap around these api with our rust
    #        server so we could easily control the workload of woocommerce
    #        and wordpress without too much of changing
    location ~ ^/wp-json/ {
        proxy_pass http://%%WOOCOMMERCE_SERVER%%;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $skip_cache;
        proxy_no_cache $skip_cache;
        add_header X-Cache-Status $upstream_cache_status;
    }

    # @NOTE: Our api to help to control our server
    location /api/ecommerce {
	proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # @NOTE: Our api to help to control collector cronjobs
    location /api/v1/variables/flush {
	proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /api/v1/config/synchronize {
	proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /api/v1/config/lock {
	proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /api/v1/config/unlock {
	proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
